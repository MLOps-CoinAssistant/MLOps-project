version: '3.4'

services:
  mlflow-server:
    env_file: ".env"
    build:
      context: .
      dockerfile: Dockerfile-mlflow
    container_name: mlflow-server
    ports:
      - ${MLFLOW_TRACKING_PORT}:${MLFLOW_TRACKING_PORT}
    environment:
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      MLFLOW_S3_ENDPOINT_URL: ${MLFLOW_S3_ENDPOINT_URL}:${MLFLOW_S3_ENDPOINT_MAIN_PORT}
      GIT_PYTHON_REFRESH: quiet
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command:
      - /bin/sh
      - -c
      - |
        mlflow server \
          --backend-store-uri ${DB_TYPE}://${DB_USER}:${DB_PW}@${MLFLOW_DB_HOST} \
          --default-artifact-root ${ARTIFACT_ROOT} \
          --host ${MLFLOW_SERVER_HOST}